---
title: "Supplementary material - priors and estimated posterior distributions"
output: 
  html_document: 
    keep_md: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, each = F}
library(BayesianTools)
```


# Prior information 

## VSEM

The VSEM model is implemented in the BayesianTools package. A model description, including a detailed description of the meaning of the parameters can be found via ?BayesianTools::VSEM. 

```{r, echo = F}
refPars <- VSEMgetDefaults()
# this adds one additional parameter for the likelihood standard deviation (see below)
refPars[12,] <- c(2, 0.1, 4) 
rownames(refPars)[12] <- "error-sd"
```

The following reference parameters (for the creation of the synthetic data) and prior ranges were used for the example with strong posterior parameter correlation (equifinality). 

```{r}
parSel = c(1:6, 12)
refPars[parSel,]
```

The following reference parameters (for the creation of the synthetic data) and prior ranges were used for the example with weak posterior parameter correlation (no equifinality).

```{r}
parSel <- c(1:3, 5:7, 12)
refPars[parSel,]
```


## 3PG

For reproducing our resutls, you should install the 3PG implementation in the threePGN package available via https://github.com/ForModLabUHel/threePGN-package

For new simulations, we recommend switching to the r3PG package, which is available from CRAN and described in Trotsiuk, Volodymyr, Florian Hartig, and David I. Forrester. "r3PG–An r package for simulating forest growth using the 3‐PG process‐based model." Methods in Ecology and Evolution 11.11 (2020): 1470-1475. This package and the paper also include some extended documentation of the model. 


```{r, echo = F}
library(threePGN)
ref.pars <- c(data_param$mode, 1, 1)
min.pars <- c(data_param$min, 0.2, 0.2)
max.pars <- c(data_param$max, 2, 2)
parameters = data.frame(reference = ref.pars, priorMin = min.pars, priorMax = max.pars)
```

The following reference parameters (for the creation of the synthetic data) and prior ranges were used for the 3PG model. 

```{r}
?threePGN::data_param
```

The meaning and units of the parameters are described in ?threePGN::data_param


# Reference posterior estimates

Here, we show the reference posterior estimates, created with an extremely long DEzs sampler. It is assumed that these are very close to the "true" (= mathematically exact) posterior distributions, and can thus be used as a reference. Since the model used in the 3PGN_sleep experiments is identical to the one in 3PGN, figures for the 3PGN_sleep are omitted. 


## VSEM - Case with strong correlation

```{r mcmc.VSEMa, echo=FALSE, fig.height=6}
library(BayesianTools)

filepath <- "C:\\Users\\spei\\Desktop\\Oldies\\SMC\\"
load(paste0(filepath,"reference_VSEMa_list.RData"))
par(mar=c(2.1,2.1,2.1,2.1))
marginalPlot(save.list[[3]], singlePanel = T)
```


## VSEM - Case without strong correlation


```{r mcmc.VSEMb, echo=FALSE, fig.height=6}
library(BayesianTools)

load(paste0(filepath,"reference_VSEMb_list.RData"))
par(mar=c(2.1,2.1,2.1,2.1))
marginalPlot(save.list[[3]], singlePanel = T)

```

## 3PG

```{r mcmc.3PG, echo=FALSE, fig.height=12}
load(paste0(filepath,"reference_threePGN_list.RData"))
par(mar=c(2.1,2.1,2.1,2.1))
marginalPlot(save.list[[3]], singlePanel = T)

```




## VSEM - Case with strong correlation


### SMC simulations
```{r smc.VSEMa, echo=FALSE, fig.height=6}

pars <- expand.grid(l = c("50", "75", "90"),
                    s = c("0.01", "0.1", "0.333", "0.5"),
                    p = c("5000", "20000", "50000", "1e+05"),
                    r = c("2", "5", "10", "20", "30"))

for(i in 1:nrow(pars)){
  print(c("Number of particles N: ", as.character(pars[i, "p"])))
  print(c("Threshold for resample-move step [% of N]: ", as.character(pars[i, "l"])))
  print(c("Scaling factor for mutation steps: ", as.character(pars[i, "s"])))
  print(c("Number of mutation steps: ", as.character(pars[i, "r"])))
  
  load(paste0(filepath, "VSEMa1\\p_", as.character(pars[i, "p"]),
              "l_", as.character(pars[i, "l"]),
              "s_", as.character(pars[i, "s"]),
              "r_", as.character(pars[i, "r"]),
              ".RData"))
  marginalPlot(smc.VSEMa)
}

```

# VSEM - Case without strong correlation

## Parameter list

## Parameter distribution

### Reference MCMC simulation

```{r mcmc.VSEMb, echo=FALSE, fig.height=6}
library(BayesianTools)

load(paste0(filepath,"reference_VSEMb_list.RData"))
par(mar=c(2.1,2.1,2.1,2.1))
marginalPlot(save.list[[3]])

```

### SMC simulations
```{r smc.VSEMb, echo=FALSE, fig.height=6}

pars <- expand.grid(l = c("50", "75", "90"),
                    s = c("0.01", "0.1", "0.333", "0.5"),
                    p = c("5000", "20000", "50000", "1e+05"),
                    r = c("2", "5", "10", "20", "30"))

for(i in 1:nrow(pars)){
  print(c("Number of particles N: ", as.character(pars[i, "p"])))
  print(c("Threshold for resample-move step [% of N]: ", as.character(pars[i, "l"])))
  print(c("Scaling factor for mutation steps: ", as.character(pars[i, "s"])))
  print(c("Number of mutation steps: ", as.character(pars[i, "r"])))
  
  load(paste0(filepath, "VSEMb1\\p_", as.character(pars[i, "p"]),
              "l_", as.character(pars[i, "l"]),
              "s_", as.character(pars[i, "s"]),
              "r_", as.character(pars[i, "r"]),
              ".RData"))
  marginalPlot(smc.VSEMb)
}

```

# 3PGN

## Parameter list

## Parameter distribution

### Reference MCMC simulation

```{r mcmc.3PG, echo=FALSE, fig.height=12}

load(paste0(filepath,"reference_threePGN_list.RData"))
par(mar=c(2.1,2.1,2.1,2.1))
marginalPlot(save.list[[3]])

```

### SMC simulations
```{r smc.3PGN, echo=FALSE, fig.height=12}

pars <- expand.grid(l = c("50", "75", "90"),
                    s = c("0.01", "0.1", "0.333", "0.5"),
                    p = c("5000", "20000", "50000", "1e+05"),
                    r = c("2", "5", "10", "20", "30"))

for(i in 1:nrow(pars)){
  
  print(c("Number of particles N: ", as.character(pars[i, "p"])))
  print(c("Threshold for resample-move step [% of N]: ", as.character(pars[i, "l"])))
  print(c("Scaling factor for mutation steps: ", as.character(pars[i, "s"])))
  print(c("Number of mutation steps: ", as.character(pars[i, "r"])))

  load(paste0(filepath, "threePGN1\\p_", as.character(pars[i, "p"]),
              "l_", as.character(pars[i, "l"]),
              "s_", as.character(pars[i, "s"]),
              "r_", as.character(pars[i, "r"]),
              ".RData"))
  marginalPlot(smc.3pg)
}

```
